<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Management System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f6f9;
        }

        .chat-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }

        .user-message {
            background-color: #e6f2ff;
            text-align: right;
        }

        .bot-message {
            background-color: #f0f0f0;
            text-align: left;
        }

        .intent-card {
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-2 bg-dark text-white min-vh-100 p-3">
            <h3 class="mb-4">Chatbot Admin</h3>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link text-white" href="#chat" data-bs-toggle="tab">
                        <i class="fas fa-comment-dots me-2"></i>Chatbot
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white" href="#intents" data-bs-toggle="tab">
                        <i class="fas fa-brain me-2"></i>Intents
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white" href="#training" data-bs-toggle="tab">
                        <i class="fas fa-graduation-cap me-2"></i>Training
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white" href="#settings" data-bs-toggle="tab">
                        <i class="fas fa-cogs me-2"></i>Settings
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white" href="#statistics" data-bs-toggle="tab">
                        <i class="fas fa-chart-line me-2"></i>Statistics
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content Area -->
        <div class="col-md-10 tab-content">
            <!-- Chatbot Interface -->
            <div id="chat" class="tab-pane active container mt-4">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                Chatbot Conversation
                            </div>
                            <div class="card-body chat-container" id="chatMessages">
                                <!-- Chat messages will be dynamically added here -->
                            </div>
                            <div class="card-footer">
                                <div class="input-group">
                                    <input type="text" id="messageInput" class="form-control"
                                           placeholder="Type your message...">
                                    <button class="btn btn-primary" id="sendMessage">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                Conversation Details
                            </div>
                            <div class="card-body" id="conversationDetails">
                                <p><strong>Session ID:</strong> <span id="sessionId">Not started</span></p>
                                <p><strong>Current Intent:</strong> <span id="currentIntentName">None</span></p>
                                <p><strong>Confidence:</strong> <span id="intentConfidence">N/A</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Intents Management -->
            <div id="intents" class="tab-pane container mt-4">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                Existing Intents
                            </div>
                            <div class="card-body" id="intentList">
                                <!-- Intents will be dynamically loaded here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                Create New Intent
                            </div>
                            <div class="card-body">
                                <form id="newIntentForm">
                                    <div class="mb-3">
                                        <label class="form-label">Intent Name</label>
                                        <input type="text" class="form-control" id="newIntentName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" id="newIntentDescription"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Training Phrases (one per line)</label>
                                        <textarea class="form-control" id="newIntentPhrases" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Responses (one per line)</label>
                                        <textarea class="form-control" id="newIntentResponses" rows="3"></textarea>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="newIntentRequiresQuery">
                                        <label class="form-check-label">
                                            Requires Database Query
                                        </label>
                                    </div>
                                    <div class="mb-3" id="dbQuerySection" style="display:none;">
                                        <label class="form-label">Database Query Template</label>
                                        <textarea class="form-control" id="newIntentDbQuery"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Create Intent</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Training Interface -->
            <div id="training" class="tab-pane container mt-4">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-warning text-white">
                                Unprocessed Queries
                            </div>
                            <div class="card-body" id="unprocessedQueriesList">
                                <!-- Unprocessed queries will be dynamically loaded here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                Process Query
                            </div>
                            <div class="card-body">
                                <form id="processQueryForm">
                                    <div class="mb-3">
                                        <label class="form-label">Query Text</label>
                                        <textarea class="form-control" id="processingQueryText" readonly></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Assign Intent</label>
                                        <select class="form-select" id="processingIntentSelect">
                                            <option value="">Select Intent</option>
                                            <!-- Intents will be dynamically populated -->
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Response</label>
                                        <textarea class="form-control" id="processingResponse"></textarea>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox"
                                               id="processingRequiresQuery">
                                        <label class="form-check-label">
                                            Requires Database Query
                                        </label>
                                    </div>
                                    <div class="mb-3" id="processingQuerySection" style="display:none;">
                                        <label class="form-label">Database Query Template</label>
                                        <textarea class="form-control" id="processingDbQuery"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success">Process Query</button>
                                    <button type="button" class="btn btn-secondary" id="ignoreQuery">Ignore
                                        Query</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div id="settings" class="tab-pane container mt-4">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        Chatbot Settings
                    </div>
                    <div class="card-body">
                        <form id="chatbotSettingsForm">
                            <div class="mb-3">
                                <label class="form-label">Confidence Threshold</label>
                                <input type="number" step="0.01" min="0" max="1" class="form-control"
                                       id="confidenceThreshold">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Responses</label>
                                <input type="number" min="1" class="form-control" id="maxResponses">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Fallback Strategy</label>
                                <select class="form-select" id="fallbackStrategy">
                                    <option value="default">Default</option>
                                    <option value="retry">Retry</option>
                                    <option value="escalate">Escalate</option>
                                </select>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="enableLearning">
                                <label class="form-check-label">
                                    Enable Machine Learning
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div id="statistics" class="tab-pane container mt-4">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                Conversation Statistics
                            </div>
                            <div class="card-body" id="conversationStats">
                                <div class="row">
                                    <div class="col-6">
                                        <h5>Total Conversations</h5>
                                        <p class="display-6" id="totalConversations">0</p>
                                    </div>
                                    <div class="col-6">
                                        <h5>Total Messages</h5>
                                        <p class="display-6" id="totalMessages">0</p>
                                    </div>
                                </div>
                                <hr>
                                <h5>Average Satisfaction</h5>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" id="avgSatisfactionBar"
                                         style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                Top Intents
                            </div>
                            <div class="card-body" id="topIntentsList">
                                <!-- Top intents will be dynamically loaded -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // Client-side JavaScript for interaction
    $(document).ready(function () {
        let currentSessionId = null;

        // Send message functionality
        $('#sendMessage').on('click', function () {
            const message = $('#messageInput').val().trim();
            if (!message) return;

            // Create user message
            appendMessage(message, 'user');

            // Simulate server request (replace with actual AJAX)
            $.ajax({
                url: '/api/chatbot/message',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    sessionId: currentSessionId || generateSessionId(),
                    message: message,
                    userId: 1 // Hardcoded for demo
                }),
                success: function (response) {
                    // Update session ID if not set
                    if (!currentSessionId) {
                        currentSessionId = response.sessionId;
                        $('#sessionId').text(currentSessionId);
                    }

                    // Append bot response
                    appendMessage(response.message, 'bot');

                    // Update intent details
                    $('#currentIntentName').text(response.detectedIntentName || 'None');
                    $('#intentConfidence').text(
                        response.confidence ?
                            (response.confidence * 100).toFixed(2) + '%' :
                            'N/A'
                    );
                },
                error: function () {
                    appendMessage('Sorry, something went wrong.', 'bot');
                }
            });

            // Clear input
            $('#messageInput').val('');
        });

        // Generate a unique session ID
        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9);
        }

        // Append message to chat
        function appendMessage(message, type) {
            const chatContainer = $('#chatMessages');
            const messageElement = $(`
                    <div class="message ${type}-message">
                        <strong>${type === 'user' ? 'You' : 'Bot'}:</strong>
                        ${message}
                    </div>
                `);
            chatContainer.append(messageElement);
            // Auto-scroll to bottom
            chatContainer.scrollTop(chatContainer[0].scrollHeight);
        }

        // Load intents for dropdown and list
        function loadIntents() {
            $.ajax({
                url: '/api/chatbot/intents',
                method: 'GET',
                success: function (intents) {
                    // Populate intent select in processing form
                    const intentSelect = $('#processingIntentSelect');
                    intentSelect.empty().append('<option value="">Select Intent</option>');

                    // Populate intent list
                    const intentList = $('#intentList');
                    intentList.empty();

                    intents.forEach(intent => {
                        // Add to intent select
                        intentSelect.append(`
                                <option value="${intent.intentName}">
                                    ${intent.intentName}
                                </option>
                            `);

                        // Add to intent list
                        const intentCard = $(`
                                <div class="card intent-card">
                                    <div class="card-body">
                                        <h5 class="card-title">${intent.intentName}</h5>
                                        <p class="card-text">${intent.description || 'No description'}</p>
                                        <button class="btn btn-sm btn-info view-intent" data-id="${intent.id}">
                                            View Details
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-intent" data-id="${intent.id}">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            `);
                        intentList.append(intentCard);
                    });
                }
            });
        }

        // Load unprocessed queries
        function loadUnprocessedQueries() {
            $.ajax({
                url: '/api/chatbot/training/unprocessed',
                method: 'GET',
                success: function (queries) {
                    const queriesList = $('#unprocessedQueriesList');
                    queriesList.empty();

                    if (queries.length === 0) {
                        queriesList.append('<p class="text-muted">No unprocessed queries.</p>');
                        return;
                    }

                    queries.forEach(query => {
                        const queryCard = $(`
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6 class="card-title">${query.text}</h6>
                                        <p class="card-text">
                                            <small>
                                                Frequency: ${query.frequency}
                                                | Created: ${new Date(query.createdAt).toLocaleString()}
                                            </small>
                                        </p>
                                        <button class="btn btn-sm btn-primary process-query"
                                                data-id="${query.id}"
                                                data-text="${query.text}">
                                            Process Query
                                        </button>
                                    </div>
                                </div>
                            `);
                        queriesList.append(queryCard);
                    });
                }
            });
        }

        // Load chatbot settings
        function loadSettings() {
            $.ajax({
                url: '/api/chatbot/settings',
                method: 'GET',
                success: function (settings) {
                    $('#confidenceThreshold').val(settings.confidenceThreshold);
                    $('#maxResponses').val(settings.maxResponses);
                    $('#fallbackStrategy').val(settings.fallbackStrategy);
                    $('#enableLearning').prop('checked', settings.enableLearning);
                }
            });
        }

        // Load statistics
        function loadStatistics() {
            $.ajax({
                url: '/api/chatbot/statistics',
                method: 'GET',
                success: function (stats) {
                    $('#totalConversations').text(stats.totalConversations || 0);
                    $('#totalMessages').text(stats.totalMessages || 0);

                    // Average satisfaction
                    const avgSatisfaction = stats.averageSatisfaction || 0;
                    $('#avgSatisfactionBar')
                        .css('width', `${avgSatisfaction * 100}%`)
                        .text(`${(avgSatisfaction * 100).toFixed(2)}%`);

                    // Top intents
                    const topIntentsList = $('#topIntentsList');
                    topIntentsList.empty();

                    if (stats.topIntents && stats.topIntents.length) {
                        stats.topIntents.forEach(intent => {
                            topIntentsList.append(`
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>${intent.intent}</span>
                                        <span class="badge bg-primary">${intent.count}</span>
                                    </div>
                                `);
                        });
                    } else {
                        topIntentsList.append('<p class="text-muted">No intent data available</p>');
                    }
                }
            });
        }

        // New Intent Form Submission
        $('#newIntentForm').on('submit', function (e) {
            e.preventDefault();

            // Prepare training phrases and responses
            const trainingPhrases = $('#newIntentPhrases').val().split('\n')
                .map(phrase => phrase.trim())
                .filter(phrase => phrase);

            const responses = $('#newIntentResponses').val().split('\n')
                .map(response => response.trim())
                .filter(response => response);

            const intentData = {
                intentName: $('#newIntentName').val(),
                description: $('#newIntentDescription').val(),
                trainingPhrases: trainingPhrases,
                responses: responses,
                requiresDbQuery: $('#newIntentRequiresQuery').is(':checked'),
                dbQuery: $('#newIntentDbQuery').val()
            };

            $.ajax({
                url: '/api/chatbot/intent',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(intentData),
                success: function () {
                    alert('Intent created successfully');
                    loadIntents();
                    // Reset form
                    $('#newIntentForm')[0].reset();
                    $('#dbQuerySection').hide();
                },
                error: function () {
                    alert('Failed to create intent');
                }
            });
        });

        // Toggle DB Query section
        $('#newIntentRequiresQuery, #processingRequiresQuery').on('change', function () {
            const target = $(this).attr('id') === 'newIntentRequiresQuery'
                ? '#dbQuerySection'
                : '#processingQuerySection';
            $(target).toggle(this.checked);
        });

        // Process Query Form Submission
        $('#processQueryForm').on('submit', function (e) {
            e.preventDefault();

            const queryData = {
                queryId: $('#processQueryForm').data('queryId'),
                intentName: $('#processingIntentSelect').val(),
                responseText: $('#processingResponse').val(),
                requiresDbQuery: $('#processingRequiresQuery').is(':checked'),
                queryTemplate: $('#processingDbQuery').val()
            };

            $.ajax({
                url: '/api/chatbot/training/process-query',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(queryData),
                success: function () {
                    alert('Query processed successfully');
                    loadUnprocessedQueries();
                    // Reset form
                    $('#processQueryForm')[0].reset();
                    $('#processingQuerySection').hide();
                },
                error: function () {
                    alert('Failed to process query');
                }
            });
        });

        // Ignore Query Button
        $('#ignoreQuery').on('click', function () {
            const queryData = {
                queryId: $('#processQueryForm').data('queryId'),
                intentName: 'ignored_query'
            };

            $.ajax({
                url: '/api/chatbot/training/process-query',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(queryData),
                success: function () {
                    alert('Query ignored');
                    loadUnprocessedQueries();
                    // Reset form
                    $('#processQueryForm')[0].reset();
                },
                error: function () {
                    alert('Failed to ignore query');
                }
            });
        });

        // Chatbot Settings Form Submission
        $('#chatbotSettingsForm').on('submit', function (e) {
            e.preventDefault();

            const settingsData = {
                confidenceThreshold: parseFloat($('#confidenceThreshold').val()),
                maxResponses: parseInt($('#maxResponses').val()),
                fallbackStrategy: $('#fallbackStrategy').val(),
                enableLearning: $('#enableLearning').is(':checked')
            };

            $.ajax({
                url: '/api/chatbot/settings',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(settingsData),
                success: function () {
                    alert('Settings updated successfully');
                },
                error: function () {
                    alert('Failed to update settings');
                }
            });
        });

        // Delegated event for processing query
        $(document).on('click', '.process-query', function () {
            const queryText = $(this).data('text');
            const queryId = $(this).data('id');

            // Populate query processing form
            $('#processingQueryText').val(queryText);
            $('#processQueryForm').data('queryId', queryId);
        });

        // Delegated event for viewing intent details
        $(document).on('click', '.view-intent', function () {
            const intentId = $(this).data('id');

            $.ajax({
                url: `/api/chatbot/intent/${intentId}`,
                method: 'GET',
                success: function (intentDetails) {
                    // You could show this in a modal or update a details section
                    alert(JSON.stringify(intentDetails, null, 2));
                },
                error: function () {
                    alert('Failed to load intent details');
                }
            });
        });

        // Delegated event for deleting intent
        $(document).on('click', '.delete-intent', function () {
            const intentId = $(this).data('id');

            if (confirm('Are you sure you want to delete this intent?')) {
                $.ajax({
                    url: `/api/chatbot/intent/${intentId}`,
                    method: 'DELETE',
                    success: function () {
                        alert('Intent deleted successfully');
                        loadIntents();
                    },
                    error: function () {
                        alert('Failed to delete intent');
                    }
                });
            }
        });

        // Initial load of data
        loadIntents();
        loadUnprocessedQueries();
        loadSettings();
        loadStatistics();
    });
</script>
</body>

</html>